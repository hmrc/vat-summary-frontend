@*
 * Copyright 2022 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import models.User
@import models.viewModels._
@import views.html.templates.formatters.money.DisplayMoney
@import views.html.templates.payments.wyoCharges._
@import views.html.templates.MtdNotificationBanner

@this(mainTemplate: MainTemplate,
      govukBreadcrumbs: GovukBreadcrumbs,
      govukBackLink: GovukBackLink,
      govukButton : GovukButton,
      govukTable : GovukTable,
      govukDetails: GovukDetails,
      displayMoney: DisplayMoney,
      mtdNotificationBanner: MtdNotificationBanner,
      standardCharge: StandardCharge,
      estimatedCharge: EstimatedCharge,
      crystallisedCharge: CrystallisedCharge)

@(model: WhatYouOweViewModel, serviceInfoContent: Html)(
  implicit request: Request[_], messages: Messages, appConfig: config.AppConfig, user: User)

@breadcrumbs = {
  @govukBreadcrumbs(Breadcrumbs(
    items = Seq(
      BreadcrumbsItem(
        content = Text(messages("breadcrumbs.bta")),
        href = Some(appConfig.btaHomeUrl)
      ),
      BreadcrumbsItem(
        content = Text(messages("vatDetails.title")),
        href = Some(controllers.routes.VatDetailsController.details.url)
      )
    )
  ))
}

@backLink = {
  @govukBackLink(BackLink(
    href = appConfig.agentClientLookupHubUrl,
    content = Text(messages("base.back"))
  ))
}

@paymentHelp = {
  <p class="govuk-body">
    @messages("whatYouOwe.details.agent.paymentHelpTwo")
    <a class="govuk-link" target="_blank" rel="noreferrer noopener" href="@appConfig.govUKDifficultiesPayingUrl">
      @messages("whatYouOwe.details.agent.paymentHelpThree")</a>
    @messages("whatYouOwe.details.agent.paymentHelpFour")
  </p>
}

@paymentHtml(chargeModel: ChargeDetailsViewModel) = @{
  chargeModel match {
    case charge: StandardChargeViewModel        => standardCharge(charge)
    case charge: CrystallisedViewModel          => crystallisedCharge(charge)
    case charge: EstimatedInterestViewModel     => estimatedCharge(charge)
    case charge: EstimatedLPP1ViewModel         => estimatedCharge(charge)
  }
}

@agentSuffix = @{
  if(user.isAgent) {".agent"} else {""}
}

@chargeRows = @{
  val individualRows = model.charges.map { charge =>
    Seq(
      TableRow(content = HtmlContent(paymentHtml(charge))),
      TableRow(content = HtmlContent(displayMoney(charge.outstandingAmount)), format = Some("numeric"))
    )
  }
  val totalRow = Seq(Seq(
    TableRow(content = Text(messages("whatYouOwe.total")), classes = "govuk-!-font-weight-bold"),
    TableRow(content = HtmlContent(displayMoney(model.totalAmount)), format = Some("numeric"), classes = "govuk-!-font-weight-bold")
  ))
  individualRows ++ totalRow
}

@mainTemplate(title = if(user.isAgent) messages("openPayments.agentTitle") else messages("openPayments.title"),
              appConfig = appConfig,
              serviceInfoContent = serviceInfoContent,
              user = Some(user),
              navLinkContent = if(user.isAgent) Some(backLink) else Some(breadcrumbs)
) {
  <div class="govuk-grid-row">
    <div class="govuk-grid-column-two-thirds">

      <h1 class="govuk-heading-xl">
        @if(user.isAgent) {@messages("whatYouOwe.agentTitle")} else {@messages("whatYouOwe.title")}
      </h1>

      @mtdNotificationBanner(model.mandationStatus)

      <p class="govuk-body govuk-!-font-size-24">@messages("whatYouOwe.totalAmountToPay")</p>
      <p class="govuk-body govuk-!-font-size-36 govuk-!-font-weight-bold govuk-!-margin-bottom-8">
        @displayMoney(model.totalAmount)
      </p>

      @govukTable(Table(
        rows = chargeRows,
        head = Some(Seq(
          HeadCell(content = Text(messages("whatYouOwe.headCell.paymentType"))),
          HeadCell(
            content = Text(messages("whatYouOwe.headCell.amountDue")),
            format = Some("numeric")
          )
        )),
        captionClasses = "govuk-table__caption--m"
      ))
      <p class="govuk-body">@messages("whatYouOwe.paymentClearanceParaOne")
        <a class="govuk-link" target="_blank" rel="noreferrer noopener" href="@appConfig.govUkPayVATUrl">
          @messages(s"whatYouOwe.paymentClearanceLink$agentSuffix")</a>@messages("common.fullStop")
      </p>

      <p class="govuk-body">@messages(s"whatYouOwe.paymentClearanceParaTwo$agentSuffix")</p>

      @if(user.isAgent && appConfig.features.overdueTimeToPayDescriptionEnabled() && model.containsOverduePayments) {
        @govukDetails(Details(
          summary = Text(messages("whatYouOwe.details.agent.paymentHelpOne")),
          content = HtmlContent(paymentHelp)
        ))
      }

      @if(!user.isAgent) {
        @govukButton(Button(
          content = Text(messages("whatYouOwe.makePayment")),
          href = Some(appConfig.unauthenticatedPaymentsUrl)
        ))
      }

      @if(user.isAgent){
        <h3 class="govuk-heading-s">@messages("whatYouOwe.agent.isIncorrectOne")</h3>
        <p class="govuk-body">@messages("whatYouOwe.agent.isIncorrectTwo")
          <a class="govuk-link" target="_blank" rel="noreferrer noopener" href="@appConfig.govUKCorrections">
            @messages("whatYouOwe.agent.isIncorrectThree")</a>.
        </p>
        <p class="govuk-body">@messages("whatYouOwe.agent.isIncorrectFour")</p>
      } else {
        @if(appConfig.features.overdueTimeToPayDescriptionEnabled() && model.containsOverduePayments) {
          <h2 id="cannot-pay-heading" class="govuk-heading-s">@messages("whatYouOwe.ifYouCannotPayOne")</h2>
          <p id=id="cannot-pay-paragraph" class="govuk-body">@messages("whatYouOwe.ifYouCannotPayTwo")
            <a class="govuk-link" target="_blank" rel="noreferrer noopener" href="@appConfig.govUKDifficultiesPayingUrl">
              @messages("whatYouOwe.ifYouCannotPayThree")</a>
            @messages("whatYouOwe.ifYouCannotPayFour")
          </p>
        }
        <h2 class="govuk-heading-s">@messages("whatYouOwe.isIncorrectOne")</h2>
        <p class ="govuk-body">@messages("whatYouOwe.isIncorrectTwo")
          <a class="govuk-link" target="_blank" rel="noreferrer noopener" href="@appConfig.govUKCorrections">
            @messages("whatYouOwe.isIncorrectThree")</a>.
        </p>
        <p class ="govuk-body">@messages("whatYouOwe.isIncorrectFour")
          <a class="govuk-link" target="_blank" rel="noreferrer noopener" href="@appConfig.unauthenticatedPaymentsUrl">
            @messages("whatYouOwe.isIncorrectFive")</a>.
        </p>
      }
    </div>
  </div>
}